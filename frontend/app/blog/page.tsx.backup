"use client";

import Link from "next/link";
import { useState, useEffect } from "react";
import Image from "next/image";
import { ArrowRight } from "lucide-react";
import { fetchPosts } from "@/lib/api-client";
import { H1, H2, H3, Body, Container, Section, Grid, MinimalCard, PrimaryButton, GhostButton, FadeInUp } from "@/components/ui/DesignSystem";
import Header from "@/components/Header";
import Footer from "@/components/Footer";
import DebugInfo from "@/components/DebugInfo";
import NewsletterSticky from "@/components/home/NewsletterSticky";
import NewsletterForm from "@/components/NewsletterForm";
import CompactNewsletter from "@/components/CompactNewsletter";

interface BlogPost {
    id: string;
    slug: string;
    title: string;
    excerpt: string;
    content: string;
    published_at: string;
    read_time: string;
    featured_image: string;
    tags: string[];
    views: number;
    category?: string;
}

export default function BlogPage() {
    const [isVisible, setIsVisible] = useState(false);
    const [posts, setPosts] = useState<BlogPost[]>([]);
    const [allPosts, setAllPosts] = useState<BlogPost[]>([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [imageErrors, setImageErrors] = useState<{ [key: string]: boolean }>({});
    const [activeFilter, setActiveFilter] = useState<string | null>(null);

    useEffect(() => {
        const timer = setTimeout(() => {
            setIsVisible(true);
        }, 300);

        // Get URL parameters for filtering
        const urlParams = new URLSearchParams(window.location.search);
        const tagFilter = urlParams.get('tag');
        const categoryFilter = urlParams.get('category');

        if (tagFilter) {
            setActiveFilter(`tag:${tagFilter}`);
        } else if (categoryFilter) {
            setActiveFilter(`category:${categoryFilter}`);
        }

        const loadPosts = async () => {
            try {
                const data = await fetchPosts();
                setAllPosts(data);

                // Apply filtering based on URL params
                let filteredData = data;
                if (tagFilter) {
                    filteredData = data.filter((post: any) => post.tags?.includes(tagFilter));
                } else if (categoryFilter) {
                    filteredData = data.filter((post: any) => post.category === categoryFilter);
                }

                setPosts(filteredData);
            } catch (err) {
                console.error('Error fetching posts:', err);
                setError(err instanceof Error ? err.message : 'Failed to fetch posts');
            } finally {
                setLoading(false);
            }
        };

        loadPosts();

        return () => clearTimeout(timer);
    }, []);

    const formatDate = (dateString: string) => {
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    };

    const handleImageError = (postId: string) => {
        console.log('‚ùå Image failed to load for post:', postId);
        setImageErrors(prev => ({
            ...prev,
            [postId]: true
        }));
    };

    const getImageSrc = (post: BlogPost) => {
        console.log('üîç Getting image src for post:', post.id, 'featured_image:', post.featured_image);
        if (imageErrors[post.id] || !post.featured_image) {
            console.log('‚ö†Ô∏è Using fallback image for post:', post.id);
            return '/images/blog/image1.jpg'; // Default fallback
        }
        console.log('‚úÖ Using featured image for post:', post.id, 'URL:', post.featured_image);
        return post.featured_image;
    };

    if (loading) {
        return (
            <>
                <Header />
                <main className="min-h-screen bg-white pt-20">
                    <div className="max-w-7xl mx-auto px-6 sm:px-8 py-16">
                        <div className="animate-pulse">
                            <div className="text-center mb-16">
                                <div className="h-12 bg-gray-200 rounded w-64 mx-auto mb-8"></div>
                                <div className="h-6 bg-gray-200 rounded w-96 mx-auto"></div>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 mb-16">
                                <div className="h-96 bg-gray-200 rounded"></div>
                                <div className="space-y-6">
                                    <div className="h-8 bg-gray-200 rounded"></div>
                                    <div className="h-4 bg-gray-200 rounded w-3/4"></div>
                                    <div className="h-20 bg-gray-200 rounded"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                <Footer />
            </>
        );
    }

    if (error) {
        return (
            <>
                <Header />
                <main className="min-h-screen bg-white pt-20">
                    <div className="max-w-7xl mx-auto px-6 sm:px-8 py-16 text-center">
                        <H1 className="mb-8">Unable to Load Posts</H1>
                        <Body className="text-lg mb-8">{error}</Body>
                        <Body className="text-sm mb-8">
                            Unable to connect to the backend API. Please check your connection.
                        </Body>
                        <Link
                            href="/"
                            className="inline-flex items-center text-gray-900 hover:text-[#236b7c] transition-colors duration-300 tracking-wide"
                        >
                            Back to Home
                        </Link>
                    </div>
                </main>
                <Footer />
            </>
        );
    }

    // Rest of the component remains the same but with updated font classes
    const featuredPost = posts[0];
    const otherPosts = posts.slice(1);

    return (
        <>
            <Header />
            <main className="min-h-screen bg-white">
                {/* Page Header */}
                <Section className="pt-24 pb-16">
                    <Container className="text-center">
                        <FadeInUp>
                            <Body className="text-xs tracking-[0.2em] uppercase text-gray-500 mb-6 block">
                                Latest Stories
                            </Body>
                            <H1 className="mb-4">
                                Stories & Guides
                            </H1>
                            <div className="h-0.5 w-16 bg-[#dca744] mx-auto mb-6"></div>
                            <Body className="text-lg max-w-2xl mx-auto">
                                Warm, useful ideas for Nigerian homes‚Äîdesign tips, everyday systems, and stories that feel like home.
                            </Body>
                        </FadeInUp>
                    </Container>
                </Section>

                {/* Active Filter Display */}
                {activeFilter && (
                    <Section className="pb-8">
                        <Container>
                            <div className="flex items-center justify-center gap-4">
                                <div className="inline-flex items-center gap-2 px-4 py-2 bg-[#dca744]/10 border border-[#dca744]/30 rounded-full">
                                    <Body className="text-sm text-[#dca744] font-medium">
                                        {activeFilter.startsWith('tag:')
                                            ? `Tag: ${activeFilter.replace('tag:', '')}`
                                            : `Category: ${activeFilter.replace('category:', '')}`
                                        }
                                    </Body>
                                </div>
                                <button
                                    onClick={() => {
                                        setActiveFilter(null);
                                        setPosts(allPosts);
                                        window.history.pushState({}, '', '/blog');
                                    }}
                                    className="text-sm text-gray-600 hover:text-[#dca744] transition-colors"
                                >
                                    Clear filter
                                </button>
                            </div>
                        </Container>
                    </Section>
                )}

                {/* Featured Post */}
                {featuredPost && (
                    <Section className="pb-16">
                        <Container>
                            <MinimalCard className="hover:border-[#dca744]">
                                <Link href={`/blog/${featuredPost.slug}`} className="group block">
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16 items-center">
                                        <div className="order-2 lg:order-1">
                                            <Body className="text-xs tracking-[0.2em] uppercase text-gray-500 mb-8 block">
                                                Featured Story
                                            </Body>

                                            <div className="flex items-center gap-6 text-sm mb-6">
                                                <Body className="text-gray-500 tracking-[0.1em] uppercase">
                                                    {formatDate(featuredPost.published_at)}
                                                </Body>
                                                <Body className="text-gray-500 tracking-[0.1em] uppercase">
                                                    {featuredPost.read_time}
                                                </Body>
                                            </div>

                                            <H2 className="mb-4 group-hover:text-[#236b7c] transition-colors duration-300">
                                                {featuredPost.title}
                                            </H2>
                                            <Body className="text-lg mb-6">
                                                {featuredPost.excerpt}
                                            </Body>
                                            <div className="inline-flex items-center text-[#dca744] tracking-wide group-hover:text-[#236b7c] transition-colors duration-300">
                                                <span>Read Full Story</span>
                                                <ArrowRight className="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform duration-300" />
                                            </div>
                                        </div>

                                        <div className="order-1 lg:order-2">
                                            <div className="aspect-[4/3] relative overflow-hidden rounded-md">
                                                {imageErrors[featuredPost.id] || !featuredPost.featured_image ? (
                                                    <div className="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                                                        <div className="text-center text-gray-400">
                                                            <svg className="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                            </svg>
                                                            <Body className="text-sm">Image not available</Body>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <Image
                                                        src={getImageSrc(featuredPost)}
                                                        alt={featuredPost.title}
                                                        width={600}
                                                        height={450}
                                                        className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                                                        onError={() => handleImageError(featuredPost.id)}
                                                    />
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </Link>
                            </MinimalCard>
                        </Container>
                    </Section>
                )}

                {/* Main Content with Sidebar */}
                {otherPosts.length > 0 && (
                    <Section className="py-16">
                        <Container>
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-8 sm:gap-12">
                                {/* Main Content - Blog Posts */}
                                <div className="lg:col-span-3">
                                    <Grid className="grid-cols-1 md:grid-cols-2">
                                        {otherPosts.map((post) => (
                                            <MinimalCard key={post.id} className="h-full hover:border-[#dca744]">
                                                <Link href={`/blog/${post.slug}`} className="block h-full group">
                                                    <div className="space-y-6 flex flex-col h-full">
                                                        <div className="aspect-[4/3] relative overflow-hidden rounded-md">
                                                            {imageErrors[post.id] || !post.featured_image ? (
                                                                <div className="w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                                                                    <div className="text-center text-gray-400">
                                                                        <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                                                        </svg>
                                                                        <Body className="text-xs">No image</Body>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <Image
                                                                    src={getImageSrc(post)}
                                                                    alt={post.title}
                                                                    width={400}
                                                                    height={300}
                                                                    className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                                                                    onError={() => handleImageError(post.id)}
                                                                />
                                                            )}
                                                        </div>

                                                        <div className="space-y-4 flex-1 flex flex-col">
                                                            <div className="flex items-center gap-4 text-sm">
                                                                <Body className="text-gray-500 tracking-[0.1em] uppercase">
                                                                    {formatDate(post.published_at)}
                                                                </Body>
                                                                <Body className="text-gray-500 tracking-[0.1em] uppercase">
                                                                    {post.read_time}
                                                                </Body>
                                                            </div>

                                                            <H3 className="group-hover:text-[#236b7c] transition-colors duration-300 line-clamp-2">
                                                                {post.title}
                                                            </H3>

                                                            <Body className="line-clamp-2 flex-1">
                                                                {post.excerpt}
                                                            </Body>

                                                            <PrimaryButton className="mt-auto w-full flex items-center justify-center gap-2 py-2">
                                                                <span>Read More</span>
                                                                <ArrowRight className="w-4 h-4 transform transition-transform duration-300" />
                                                            </PrimaryButton>
                                                        </div>
                                                    </div>
                                                </Link>
                                            </MinimalCard>
                                        ))}
                                    </Grid>
                                </div>

                                {/* Sidebar */}
                                <div className="lg:col-span-1 space-y-8">
                                    {/* Trending Reads */}
                                    <MinimalCard>
                                        <H3 className="mb-6">
                                            Trending Reads
                                        </H3>
                                        <div className="space-y-4">
                                            {allPosts.slice(0, 5).map((post, index) => (
                                                <div key={post.id} className="group">
                                                    <Link href={`/blog/${post.slug}`} className="block">
                                                        <div className="flex gap-3">
                                                            <span className="font-bold text-2xl text-gray-300 group-hover:text-[#dca744] transition-colors">
                                                                {index + 1}.
                                                            </span>
                                                            <div className="flex-1">
                                                                <Body className="text-sm group-hover:text-[#236b7c] transition-colors line-clamp-2 leading-tight">
                                                                    {post.title}
                                                                </Body>
                                                                <Body className="text-xs text-gray-500 mt-1">
                                                                    {post.read_time}
                                                                </Body>
                                                            </div>
                                                        </div>
                                                    </Link>
                                                </div>
                                            ))}
                                        </div>
                                    </MinimalCard>

                                    {/* Newsletter Signup */}
                                    <CompactNewsletter />

                                    {/* Popular Categories */}
                                    <MinimalCard className="bg-gray-50">
                                        <H3 className="mb-4">
                                            Categories
                                        </H3>
                                        <div className="space-y-2">
                                            {['Cleaning', 'Organization', 'Life', 'Decorating', 'Energy Savings', 'Security & Safety', 'Smart & Tech', 'Home Projects'].map((category) => (
                                                <Link
                                                    key={category}
                                                    href={`/blog?category=${encodeURIComponent(category)}`}
                                                    className="block text-sm text-gray-600 hover:text-[#236b7c] transition-colors py-1"
                                                >
                                                    {category}
                                                </Link>
                                            ))}
                                        </div>
                                    </MinimalCard>
                                </div>
                            </div>
                        </Container>
                    </Section>
                )}

                {/* Newsletter CTA Section */}
                <Section className="py-16 bg-neutral-50">
                    <div className="max-w-4xl mx-auto px-4 sm:px-6 text-center">
                        <span className="font-gilroy font-light text-xs tracking-[0.2em] uppercase text-neutral-500 mb-6 block">
                            Stay Updated
                        </span>
                        <h2 className="font-gilroy font-extra-bold text-3xl sm:text-4xl text-black mb-4">
                            We‚Äôll send you beautiful, useful finds for your home
                        </h2>
                        <p className="font-gilroy font-light text-lg text-black max-w-xl mx-auto mb-6">
                            One thoughtful email a week‚Äîsmart tips, weekend projects, and curated finds made for Nigerian homes.
                        </p>
                        <div className="max-w-xl mx-auto"><NewsletterForm variant="inline" source="blog_main" /></div>
                    </div>
                </section>
            </main>
            <NewsletterSticky />
            <Footer />
            <DebugInfo />
        </>
    );
} 